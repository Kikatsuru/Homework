simplified version from the master branch